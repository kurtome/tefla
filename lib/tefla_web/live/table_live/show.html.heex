<.section>
    <h1 class="text-4xl">Table Prototype</h1>
</.section>

<.section>
    <button phx-click="deal" class="border border-black rounded px-2">
        Deal
    </button>

    <div>
        <p>Deck size: <%= length(@table.deck) %></p>
        <p>Players' hand size: <%= Enum.map(@table.players, fn p -> length(p.hand) end) |> Enum.join(", ") %></p>
        <p>Players' tricks taken: <%= Enum.map(@table.players, fn p -> length(p.tricks_taken) end) |> Enum.join(", ") %></p>
    </div>
</.section>

<.section>
    <%= for {player, player_i} <- Enum.with_index(@table.players) do %>
      <div class="flex" >
          <% current_turn = Tefla.Table.current_turn(@table) %>
          <% {:ok, valid_moves} = Tefla.GameRules.Standard.valid_moves(@table) %>
          <%= for {card, card_i} <- Enum.with_index(player.hand) do %>
            <% playable? = Enum.any?(valid_moves, fn m -> m.player == player_i and m.hand_card == card_i end) %>
            <div
                    phx-click="play_card"
                    phx-value-player={player_i}
                    phx-value-hand_card={card_i}
                    class={"w-16 border #{if(playable?, do: "cursor-pointer")}"}>
                <%= if player_i == current_turn do %>
                   <%= card_img(card, img_class: if(playable?, do: "", else: "filter brightness-75")) %>
                <% else %>
                    <%= card_back() %>
                <% end %>
            </div>
          <% end %>
      </div>
    <% end %>
    <div class="flex" >
        <% winning_card_index = Tefla.GameRules.Standard.trick_winning_card(@table) %>
        <%= for {card, i} <- Enum.with_index(@table.trick) do %>
            <%= if winning_card_index == i do %>
               <div phx-click="collect_trick" >
                   <%= card_img(card) %>
               </div>
            <% else %>
               <%= card_img(card, img_class: "filter brightness-75") %>
            <% end %>
        <% end %>
    </div>
</.section>
